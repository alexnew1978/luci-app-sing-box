name: Build packages

on:
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        arch:
          - aarch64_generic
        sdk:
          - openwrt-24.10

    steps:
      - name: Checkout repository
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Set up Docker for OpenWrt build
        run: |
          # Устанавливаем Docker (если его еще нет)
          sudo apt-get update
          sudo apt-get install -y docker.io

          # Загружаем официальный Docker-образ для OpenWrt
          docker pull openwrtorg/openwrt

          # Строим OpenWrt в контейнере
          docker run --rm -v $(pwd):/workdir openwrtorg/openwrt bash -c "
            cd /workdir && \
            ./scripts/feeds update -a && \
            ./scripts/feeds install -a && \
            make package/luci-app-sing-box/compile V=s
          "

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-sing-box
          path: bin/packages/${{ matrix.arch }}/luci-app-sing-box/*.ipk
